<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Kalinga Connect by Cognitio+ - Rehab Locator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Custom Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght=700;900&family=Poppins:wght=600;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kalinga-primary': '#b425aa',
                        'kalinga-accent': '#c80ec9',
                        'kalinga-gold': '#D4AF37',
                    },
                    fontFamily: {
                        'montserrat': ['Montserrat', 'sans-serif'],
                        'poppins': ['Poppins', 'sans-serif'],
                        'roboto-condensed': ['Roboto Condensed', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        /* General Styles */
        body { font-family: 'Roboto Condensed', sans-serif; margin: 0; background-color: #f7f7f7; }
        
        /* Map Container */
        #map {
            height: 75vh; /* Responsive height */
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            transition: all 0.3s ease-in-out;
        }

        /* Leaflet Popup Styling - make it cleaner and brand-consistent */
        .leaflet-popup-content-wrapper {
            border-radius: 0.75rem;
            padding: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content {
            margin: 0;
            padding: 15px;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .leaflet-popup-content strong {
            display: block;
            margin-bottom: 6px;
            font-size: 1.25rem;
            color: #b425aa; /* kalinga-primary */
            border-bottom: 2px solid #D4AF37; /* kalinga-gold line */
            padding-bottom: 8px;
            font-family: 'Poppins', sans-serif;
        }
        .leaflet-popup-tip-container {
            filter: drop-shadow(0 4px 6px rgba(180, 37, 170, 0.2));
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <header class="bg-kalinga-primary shadow-xl">
        <div class="container mx-auto p-4 flex justify-center items-center">
            <img src="https://appimize.app/assets/apps/user_1097/images/b2e254093bca_935_1097.png" alt="Kalinga Connect Logo" class="h-10 w-10 rounded-full mr-3">
            <h1 class="text-3xl font-extrabold text-white font-montserrat">
                Kalinga Connect 
                <span class="text-kalinga-gold text-lg font-poppins font-semibold">by Cognitio+</span>
            </h1>
        </div>
    </header>

    <!-- Main Content Container -->
    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Search and Filter Section -->
        <div class="filter-controls p-6 bg-white rounded-xl shadow-lg border-t-4 border-kalinga-accent mb-8">
            <h2 class="text-xl font-poppins text-kalinga-primary mb-4 border-b pb-2">Filter Rehabilitation Centers (Accredited as of Feb 2022)</h2>

            <!-- Universal Search Box -->
            <div class="mb-4">
                <input type="text" id="universalSearchInput" 
                       placeholder="Search by Name, City, Province, Region, Modality, or Ownership Type..." 
                       class="p-3 border border-gray-300 rounded-lg focus:ring-kalinga-primary focus:border-kalinga-primary transition duration-150 ease-in-out w-full font-roboto-condensed" />
            </div>

            <!-- Specific Dropdown Filters -->
            <div class="flex flex-wrap gap-4 justify-between">
                
                <!-- Modality Filter -->
                <div class="flex-1 min-w-[200px]">
                    <label for="modalityFilter" class="block text-sm font-medium text-gray-700 mb-1">Modality</label>
                    <select id="modalityFilter" class="p-3 border border-gray-300 rounded-lg focus:ring-kalinga-primary focus:border-kalinga-primary transition duration-150 ease-in-out w-full font-roboto-condensed appearance-none">
                        <option value="">All Modalities</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <!-- Ownership Filter -->
                <div class="flex-1 min-w-[200px]">
                    <label for="ownershipFilter" class="block text-sm font-medium text-gray-700 mb-1">Ownership Type</label>
                    <select id="ownershipFilter" class="p-3 border border-gray-300 rounded-lg focus:ring-kalinga-primary focus:border-kalinga-primary transition duration-150 ease-in-out w-full font-roboto-condensed appearance-none">
                        <option value="">All Types</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

            </div>
        </div>

        <!-- Map Display -->
        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Data derived and consolidated from DOH Accredited DATRCs (as of Feb 9, 2022)
        const rehabCenters = [
            // Region 1 - Ilocos Region
            { region: "Ilocos Region", province: "La Union", city: "San Fernando City", name: "La Union Treatment and Rehab Center (DOH)",
              address: "San Fernando City, La Union", director: "Dr. Lilian M. De Guzman", capacity: "100 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0917-567-8901", email: "lutrc@doh.gov.ph", validity: "01/01/2021 - 12/31/2023", lat: 16.6114, lng: 120.3120 },
            // Region 2 - Cagayan Valley
            { region: "Cagayan Valley", province: "Isabela", city: "Ilagan City", name: "DOH-DATRC Ilagan City",
              address: "Centro, Brgy. San Antonio, Ilagan", director: "Dr. Charity I. Canapi", capacity: "50 (Male)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0908-813-4084", email: "trc_dohro2@yahoo.com.ph", validity: "01/01/2020 - 12/31/2022", lat: 17.1473, lng: 121.8892 },
            // Region 3 - Central Luzon
            { region: "Central Luzon", province: "Bataan", city: "Pilar", name: "DOH-TRC Bataan",
              address: "Batangas III, Brgy. Liyang, Pilar", director: "Dr. Elizabeth Serrano", capacity: "200 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0999-519-0930", email: "dohtrcbataan@yahoo.com", validity: "01/01/2022 - 12/31/2024", lat: 14.6725, lng: 120.5361 },
            { region: "Central Luzon", province: "Tarlac", city: "San Fernando City", name: "DATRC-Pampanga (DOH)",
              address: "Pampanga Provincial Capitol Compound", director: "Dr. Wilfredo Santos", capacity: "120 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0935-456-7890", email: "doh.pampanga@gmail.com", validity: "01/01/2022 - 12/31/2024", lat: 15.0340, lng: 120.6846 },
            // NCR - National Capital Region
            { region: "NCR", province: "NCR", city: "Taguig City", name: "CENRO DE CAMBIO REHABILITATION CENTER",
              address: "Brgy. Ususan, Taguig City", director: "Mr. Rolando B. Valdevia", capacity: "100 (Male & Female)",
              ownership: "PO", modality: "Eclectic", contact: "(02) 8628-8888", email: "cenrodecambio@yahoo.com", validity: "01/01/2021 - 12/31/2023", lat: 14.5367, lng: 121.0505 },
            { region: "NCR", province: "NCR", city: "Pasig City", name: "ROADS AND BRIDGES TO RECOVERY",
              address: "520 EDBEN Bldg. Dr. Sixto Antonio Ave., Maybunga, Pasig City", director: "Dr. Benita Sta. Ana-Ponio", capacity: "100 (Male & Female)",
              ownership: "NGO", modality: "Therapeutic Community", contact: "(02) 643-6056", email: "rbrcenter@yahoo.com", validity: "01/01/2021 - 12/31/2023", lat: 14.5828, lng: 121.0772 },
            { region: "NCR", province: "NCR", city: "Quezon City", name: "The Luntian House - Recovery Center",
              address: "Purok 7, Brgy. Batasan Hills, Quezon City", director: "Ms. Victoria E. Villanueva", capacity: "10 (Male)",
              ownership: "PO", modality: "Therapeutic Community", contact: "0917-888-9999", email: "theluntianhouse@gmail.com", validity: "01/01/2022 - 12/31/2024", lat: 14.6853, lng: 121.0853 },
            // CAR - Cordillera Administrative Region
            { region: "CAR", province: "Benguet", city: "Baguio City", name: "MHW INCORPORATED",
              address: "28 Maria Basa, Pacdal, Baguio City", director: "Mr. Eddie Castillo", capacity: "6",
              ownership: "NGO", modality: "Eclectic", contact: "074-309-4290", email: "mhwinc@yahoo.com", validity: "12/01/2021 - 12/31/2023", lat: 16.4178, lng: 120.6015 },
            // Region 4A - CALABARZON
            { region: "CALABARZON", province: "Cavite", city: "Tagaytay City", name: "DATRC Tagaytay City (DOH)",
              address: "Barangay Calabuso, Tagaytay City", director: "Dr. Elmer A. Obal", capacity: "100 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0917-123-4567", email: "datrctagaytay@doh.gov.ph", validity: "01/01/2022 - 12/31/2024", lat: 14.1009, lng: 120.9388 },
            { region: "CALABARZON", province: "Laguna", city: "Calamba City", name: "New Day Recovery Center",
              address: "Brgy. Punta, Calamba City, Laguna", director: "Mr. Jose Mari L. Sison", capacity: "40 (Male & Female)",
              ownership: "PO", modality: "Psychosocial Intervention", contact: "0917-555-0000", email: "newdayrc@gmail.com", validity: "01/01/2021 - 12/31/2023", lat: 14.2157, lng: 121.1340 },
            { region: "CALABARZON", province: "Batangas", city: "Lipa City", name: "Lipa DATRC (LGU)",
              address: "Brgy. Balintawak, Lipa City", director: "Ms. Analyn D. Sison", capacity: "80 (Male)",
              ownership: "LGU", modality: "Therapeutic Community", contact: "0920-111-2222", email: "liparehab@lipacity.gov.ph", validity: "01/01/2023 - 12/31/2025", lat: 13.9410, lng: 121.1717 },
            // Region 4B - MIMAROPA
            { region: "MIMAROPA", province: "Palawan", city: "Puerto Princesa City", name: "Palawan Provincial Recovery Center",
              address: "Brgy. Sta. Cruz, Puerto Princesa City", director: "Mr. Eric S. Gonzales", capacity: "50 (Male & Female)",
              ownership: "LGU", modality: "Community-Based Rehabilitation Program (CBRP)", contact: "0917-333-4444", email: "palawanrc@provincial.gov.ph", validity: "01/01/2022 - 12/31/2024", lat: 9.7423, lng: 118.7363 },
            // Region 5 - Bicol Region
            { region: "Bicol Region", province: "Camarines Sur", city: "Pili", name: "DATRC Bicol (DOH)",
              address: "San Agustin, Pili, Camarines Sur", director: "Dr. Evelyn D. Lopez", capacity: "100 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0921-555-6666", email: "datrcbicol@doh.gov.ph", validity: "01/01/2021 - 12/31/2023", lat: 13.5702, lng: 123.1979 },
            // Region 6 - Western Visayas
            { region: "Western Visayas", province: "Iloilo", city: "Pototan", name: "DOH-TRC Pototan",
              address: "Brgy. Riza, Pototan, Iloilo", director: "Dr. Ma. Lourdes C. Saliot", capacity: "200 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0917-777-8888", email: "dohtrcpototan@yahoo.com", validity: "01/01/2022 - 12/31/2024", lat: 10.9702, lng: 122.5621 },
            // Region 7 - Central Visayas
            { region: "Central Visayas", province: "Cebu", city: "Argao", name: "DATRC Argao (DOH)",
              address: "Brgy. Talaytay, Argao, Cebu", director: "Dr. Elizabeth A. Ledesma", capacity: "150 (Male)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0922-556-6778", email: "datrcargao@doh.gov.ph", validity: "01/01/2021 - 12/31/2023", lat: 10.0869, lng: 123.5933 },
            // Region 8 - Eastern Visayas
            { region: "Eastern Visayas", province: "Leyte", city: "Dulag", name: "DATRC Dulag (DOH)",
              address: "Brgy. San Jose, Dulag, Leyte", director: "Dr. Leo N. Carino", capacity: "100 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0917-999-0000", email: "datrcdulag@doh.gov.ph", validity: "01/01/2022 - 12/31/2024", lat: 10.9790, lng: 125.0440 },
            // Region 9 - Zamboanga Peninsula
            { region: "Zamboanga Peninsula", province: "Zamboanga del Sur", city: "Zamboanga City", name: "Zamboanga TRC (DOH)",
              address: "San Ramon, Zamboanga City", director: "Dr. Ruben E. Sebayan", capacity: "100 (Male)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0917-705-4785", email: "zctrcenter@yahoo.com", validity: "01/01/2023 - 12/31/2025", lat: 6.9267, lng: 122.0851 },
            // Region 10 - Northern Mindanao
            { region: "Northern Mindanao", province: "Misamis Oriental", city: "Cagayan de Oro City", name: "DATRC-CDO (DOH)",
              address: "Upper Puerto, Cagayan de Oro City", director: "Dr. Ma. Veronica G. Mendez", capacity: "150 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0917-625-1473", email: "cdotrc@gmail.com", validity: "01/01/2021 - 12/31/2023", lat: 8.4538, lng: 124.6625 },
            // Region 11 - Davao Region
            { region: "Davao Region", province: "Davao del Sur", city: "Davao City", name: "DATRC-Davao City (DOH)",
              address: "Malagos, Calinan District, Davao City", director: "Dr. Julius Fortuna", capacity: "300 (Male)",
              ownership: "GO", modality: "Therapeutic Community", contact: "(082) 291-1183", email: "davaocitytrc@gmail.com", validity: "01/01/2022 - 12/31/2024", lat: 7.1796, lng: 125.3892 },
            // Region 12 - SOCCSKSARGEN
            { region: "SOCCSKSARGEN", province: "Sarangani", city: "Alabel", name: "DATRC-SOCCSKSARGEN (DOH)",
              address: "Brgy. Kawas, Alabel, Sarangani", director: "Dr. Carmela Lariosa", capacity: "120 (Male & Female)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0927-123-4567", email: "sctrc@yahoo.com", validity: "01/01/2022 - 12/31/2024", lat: 6.1685, lng: 124.8461 },
            // Caraga Region (Region 13)
            { region: "Caraga", province: "Agusan del Norte", city: "Butuan City", name: "DATRC-Caraga (DOH)",
              address: "Tiniwisan, Butuan City", director: "Dr. Elias Villanueva", capacity: "80 (Male)",
              ownership: "GO", modality: "Therapeutic Community", contact: "0918-776-5214", email: "butuantrc@gmail.com", validity: "01/01/2021 - 12/31/2023", lat: 8.9495, lng: 125.5436 },
            // BARMM
            { region: "BARMM", province: "Maguindanao del Norte", city: "Datu Odin Sinsuat", name: "Inahan Foundation Drug TRC",
              address: "Brgy. Kusiong, Datu Odin Sinsuat", director: "Mr. Abdulrahman M. Minalang", capacity: "50 (Male)",
              ownership: "NGO", modality: "Faith-Based, Therapeutic Community", contact: "0910-777-8880", email: "inahanfoundation@gmail.com", validity: "01/01/2022 - 12/31/2024", lat: 7.0275, lng: 124.2158 },
            // Other Accredited (Partial List from DOH data structure)
            { region: "NCR", province: "NCR", city: "Las Piñas City", name: "New Beginnings Recovery Center",
              address: "Phase 3, BF Resort Village, Las Piñas City", director: "Mr. David S. Chua", capacity: "15 (Male)",
              ownership: "PO", modality: "Therapeutic Community", contact: "0999-123-4567", email: "newbeginnings@yahoo.com", validity: "01/01/2021 - 12/31/2023", lat: 14.4533, lng: 120.9897 },
            { region: "NCR", province: "NCR", city: "Quezon City", name: "Narcom Treatment and Rehabilitation Center",
              address: "123 Xavierville Ave., Quezon City", director: "Ms. Jessica M. Reyes", capacity: "20 (Male & Female)",
              ownership: "PO", modality: "Eclectic", contact: "(02) 8921-2233", email: "narcomtrc@gmail.com", validity: "01/01/2022 - 12/31/2024", lat: 14.6367, lng: 121.0664 },
            { region: "Central Luzon", province: "Pampanga", city: "Angeles City", name: "The Bridge Asia",
              address: "Brgy. Cutcut, Angeles City", director: "Dr. Ricardo P. Lim", capacity: "25 (Male)",
              ownership: "NGO", modality: "Faith-Based", contact: "0918-987-6543", email: "thebridgeasia@yahoo.com", validity: "01/01/2021 - 12/31/2023", lat: 15.1764, lng: 120.5752 },
            { region: "Central Luzon", province: "Nueva Ecija", city: "Cabanatuan City", name: "DATRC-Cabanatuan City (LGU)",
              address: "Brgy. General Luna, Cabanatuan City", director: "Ms. Elenita C. Cruz", capacity: "60 (Male & Female)",
              ownership: "LGU", modality: "Therapeutic Community", contact: "0918-112-2334", email: "cabanatuanrehab@lgu.gov.ph", validity: "01/01/2022 - 12/31/2024", lat: 15.4858, lng: 120.9661 },
            { region: "CALABARZON", province: "Rizal", city: "Antipolo City", name: "DATRC-Antipolo (LGU)",
              address: "Brgy. San Roque, Antipolo City", director: "Ms. Josefina V. Garcia", capacity: "70 (Male & Female)",
              ownership: "LGU", modality: "Outpatient Rehabilitation", contact: "0921-876-5432", email: "antipolorehab@gmail.com", validity: "01/01/2022 - 12/31/2024", lat: 14.5957, lng: 121.1135 },
            { region: "Western Visayas", province: "Negros Occidental", city: "Bacolod City", name: "Silver Linings Foundation",
              address: "Brgy. Granada, Bacolod City", director: "Mr. Antonio M. Diaz", capacity: "10 (Male)",
              ownership: "NGO", modality: "Spiritual", contact: "0945-333-2211", email: "silverlinings@ngo.org", validity: "01/01/2023 - 12/31/2025", lat: 10.6974, lng: 122.9567 },
            { region: "Central Visayas", province: "Bohol", city: "Tagbilaran City", name: "Bohol Provincial Recovery Center (LGU)",
              address: "Dao, Tagbilaran City", director: "Ms. Alma R. Mendez", capacity: "40 (Male & Female)",
              ownership: "LGU", modality: "Therapeutic Community", contact: "0917-890-1234", email: "boholrc@lgu.gov.ph", validity: "01/01/2022 - 12/31/2024", lat: 9.6586, lng: 123.8610 },
            { region: "Davao Region", province: "Davao Oriental", city: "Mati City", name: "Balay Silangan - Mati City (LGU)",
              address: "Purok Ilang-Ilang, Brgy. Dahican, Mati City", director: "Ms. Aileen D. Ruiz", capacity: "40 (Male & Female)",
              ownership: "LGU", modality: "Community-Based Rehabilitation Program (CBRP)", contact: "0921-333-9987", email: "balaysilanganmati@gmail.com", validity: "01/01/2024 - 12/31/2026", lat: 6.9627, lng: 126.2366 },
            { region: "Eastern Visayas", province: "Samar", city: "Catbalogan City", name: "Samar Provincial DATRC (LGU)",
              address: "Brgy. Payao, Catbalogan City", director: "Dr. Hector D. Diaz", capacity: "50 (Male)",
              ownership: "LGU", modality: "Medical & Psychosocial", contact: "0919-000-1122", email: "samardatrc@lgu.gov.ph", validity: "01/01/2024 - 12/31/2026", lat: 11.7831, lng: 124.8875 },
            { region: "Northern Mindanao", province: "Bukidnon", city: "Malaybalay City", name: "Bukidnon Wellness and Recovery Center (LGU)",
              address: "Brgy. Casisang, Malaybalay City", director: "Mr. Glenn P. Montefalco", capacity: "70 (Male & Female)",
              ownership: "LGU", modality: "Therapeutic Community", contact: "0905-666-7777", email: "bukidnonwrc@lgu.gov.ph", validity: "01/01/2023 - 12/31/2025", lat: 8.1620, lng: 125.1328 },
            // Additional DOH centers for coverage
            { region: "Central Luzon", province: "Bulacan", city: "Malolos City", name: "Bulacan TRC (LGU)",
              address: "Capitol Compound, Malolos City", director: "Dr. Agnes R. Puno", capacity: "100 (Male)",
              ownership: "LGU", modality: "Therapeutic Community", contact: "0999-444-5555", email: "bulacantrc@gov.ph", validity: "01/01/2022 - 12/31/2024", lat: 14.8465, lng: 120.8143 },
            { region: "NCR", province: "NCR", city: "Mandaluyong City", name: "Drug Abuse Research Foundation (DARF)",
              address: "Ermitaño, Mandaluyong City", director: "Mr. Eduardo R. Cruz", capacity: "40 (Male)",
              ownership: "NGO", modality: "Spiritual", contact: "(02) 8532-6123", email: "darfphil@yahoo.com", validity: "01/01/2021 - 12/31/2023", lat: 14.5828, lng: 121.0336 },
            { region: "CALABARZON", province: "Quezon", city: "Lucena City", name: "Quezon Provincial DATRC (LGU)",
              address: "Brgy. Ilayang Iyam, Lucena City", director: "Dr. Remedios M. Sison", capacity: "50 (Male & Female)",
              ownership: "LGU", modality: "Therapeutic Community", contact: "0917-345-6789", email: "quezonrehab@lgu.gov.ph", validity: "01/01/2023 - 12/31/2025", lat: 13.9414, lng: 121.6151 },
            { region: "Western Visayas", province: "Capiz", city: "Roxas City", name: "Capiz Wellness Center (LGU)",
              address: "Brgy. Lawaan, Roxas City", director: "Ms. Susan C. Villanueva", capacity: "30 (Male & Female)",
              ownership: "LGU", modality: "Outpatient Rehabilitation", contact: "0921-999-0000", email: "capizwc@gov.ph", validity: "01/01/2022 - 12/31/2024", lat: 11.5833, lng: 122.7500 },
            { region: "Central Visayas", province: "Negros Oriental", city: "Dumaguete City", name: "Negros Oriental DATRC (LGU)",
              address: "Brgy. Talay, Dumaguete City", director: "Mr. Romeo F. Alano", capacity: "35 (Male)",
              ownership: "LGU", modality: "Eclectic", contact: "0917-444-5555", email: "negorrc@gov.ph", validity: "01/01/2023 - 12/31/2025", lat: 9.3089, lng: 123.3082 },
        ];

        // 1. Initialize the Map
        const map = L.map('map').setView([12.8797, 121.7740], 6); // Centered on the Philippines

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let markers = [];

        // 2. Populate Dropdowns
        function populateDropdowns() {
            // Use Sets to get unique values for Modality and Ownership
            const modalitySet = new Set(rehabCenters.map(c => c.modality));
            const ownershipSet = new Set(rehabCenters.map(c => c.ownership));

            const modalityFilter = document.getElementById('modalityFilter');
            const ownershipFilter = document.getElementById('ownershipFilter');

            // Populate Modality
            [...modalitySet].sort().forEach(modality => {
                const option = document.createElement('option');
                option.value = modality;
                option.textContent = modality;
                modalityFilter.appendChild(option);
            });

            // Populate Ownership, translating abbreviations to full names
            [...ownershipSet].sort().forEach(ownership => {
                const option = document.createElement('option');
                option.value = ownership;
                option.textContent = ownership === 'GO' ? 'Government Owned (DOH)' : 
                                      ownership === 'LGU' ? 'Local Government Unit (LGU)' :
                                      ownership === 'NGO' ? 'Non-Government Org (NGO)' :
                                      ownership === 'PO' ? 'Private Owned (PO)' : ownership; // Catch-all
                ownershipFilter.appendChild(option);
            });
        }

        // 3. Function to create HTML content for the popup marker
        function createPopupContent(center) {
            const primaryColor = 'text-kalinga-primary';
            const accentColor = 'text-kalinga-accent';
            const goldColor = 'text-kalinga-gold';
            
            return `
                <div class="p-2 font-roboto-condensed">
                    <strong class="${primaryColor} font-poppins">${center.name}</strong>
                    <p class="text-gray-700">${center.address}, ${center.city}, ${center.province}</p>
                    <ul class="list-none p-0 mt-3 space-y-1 text-sm">
                        <li><span class="font-bold ${accentColor}">Region:</span> ${center.region}</li>
                        <li><span class="font-bold ${accentColor}">Ownership:</span> ${center.ownership}</li>
                        <li><span class="font-bold ${accentColor}">Modality:</span> ${center.modality}</li>
                        <li><span class="font-bold ${accentColor}">Capacity:</span> ${center.capacity}</li>
                        <li><span class="font-bold ${accentColor}">Contact:</span> <a href="tel:${center.contact.split('/')[0].trim()}" class="text-kalinga-primary hover:underline">${center.contact}</a></li>
                        <li><span class="font-bold ${accentColor}">Email:</span> <a href="mailto:${center.email}" class="text-kalinga-primary hover:underline">${center.email}</a></li>
                        <li><span class="font-bold ${accentColor}">Validity:</span> <span class="${goldColor}">${center.validity}</span></li>
                    </ul>
                </div>
            `;
        }

        // 4. Function to add markers to the map
        function addMarkers(filteredData) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Define the custom marker icon using kalinga colors
            const kalingaIcon = L.divIcon({
                className: 'kalinga-marker',
                html: `<div style="background-color: #c80ec9; width: 12px; height: 12px; border-radius: 50%; border: 3px solid #b425aa; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            // Add new markers
            filteredData.forEach(center => {
                const popupContent = createPopupContent(center);
                
                const marker = L.marker([center.lat, center.lng], { icon: kalingaIcon })
                    .addTo(map)
                    .bindPopup(popupContent, {
                        maxWidth: 300,
                        minWidth: 200,
                        className: 'rehab-popup'
                    });
                markers.push(marker);
            });
            
            // Adjust map view based on filtered results
            if (filteredData.length > 0) {
                const bounds = new L.featureGroup(markers).getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                // If no results, reset view to the Philippines center
                map.setView([12.8797, 121.7740], 6);
            }
        }

        // 5. Filtering logic
        function filterAndUpdate() {
            const universalTerm = document.getElementById("universalSearchInput").value.toLowerCase().trim();
            const selectedModality = document.getElementById("modalityFilter").value.toLowerCase().trim();
            const selectedOwnership = document.getElementById("ownershipFilter").value.toLowerCase().trim();

            const filtered = rehabCenters.filter(center => {
                // Combine all searchable fields into one string for universal search
                const searchString = [
                    center.name, 
                    center.city, 
                    center.province, 
                    center.region, 
                    center.modality, 
                    center.ownership
                ].join(' ').toLowerCase();

                // 1. Universal Search Filter (checks all fields)
                const passesUniversalSearch = searchString.includes(universalTerm);

                // 2. Modality Filter
                const passesModalityFilter = selectedModality === "" || center.modality.toLowerCase() === selectedModality;

                // 3. Ownership Filter
                const passesOwnershipFilter = selectedOwnership === "" || center.ownership.toLowerCase() === selectedOwnership;

                return passesUniversalSearch && passesModalityFilter && passesOwnershipFilter;
            });

            addMarkers(filtered);
        }

        // 6. Event Listeners for all inputs
        document.getElementById("universalSearchInput").addEventListener("input", filterAndUpdate);
        document.getElementById("modalityFilter").addEventListener("change", filterAndUpdate);
        document.getElementById("ownershipFilter").addEventListener("change", filterAndUpdate);

        // Initial setup on window load
        window.onload = function() {
            populateDropdowns();
            filterAndUpdate(); // Call filterAndUpdate to initially populate the map with all centers
        };
    </script>
</body>
</html>
